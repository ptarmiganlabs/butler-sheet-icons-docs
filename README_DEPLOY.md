# Deployment (Butler Sheet Icons Docs)

Instructions for building and deploying the documentation site.  
Audience: developers/maintainers.

## Scripts (package.json)

| Script       | Purpose                                                                                           |
| ------------ | ------------------------------------------------------------------------------------------------- |
| pre:version  | Fetch latest released Butler Sheet Icons tag via GitHub API → writes `docs/.vitepress/version.js` |
| docs:dev     | Generate version file, start VitePress dev server                                                 |
| docs:build   | Generate version file, build static site into `docs/.vitepress/dist`                              |
| docs:preview | Build then preview locally                                                                        |
| deploy       | Build then publish dist folder to `gh-pages` branch using `gh-pages` package                      |
| deploy:ci    | Build only (used by GitHub Pages workflow artifact upload)                                        |

`pre:version` runs automatically for all build/dev/preview commands. It tolerates API failures (falls back to existing file or `v0.0.0`). To avoid anonymous rate limiting locally, export `GITHUB_TOKEN` (or `GH_TOKEN`).

Generated file example:

```js
// Auto-generated by scripts/fetch-bsi-version.mjs – do not edit
export const version = "v3.8.0";
```

Consume it from VitePress config or pages as needed (import path: `../.vitepress/version.js`).

## Automated Deployment (GitHub Pages)

- Workflow: `.github/workflows/deploy.yml`.
- Trigger: push to `main` or manual dispatch.
- Steps: checkout → install (npm ci) → `npm run docs:build` (invokes version fetch) → upload artifact → deploy with `actions/deploy-pages`.
- Output: Published to GitHub Pages (custom domain if CNAME present).

Prereq (one-time): In repo Settings → Pages: Source = GitHub Actions. Custom domain optional.

## Manual Deployment (Local)

One-time:

1. `npm install`
2. (Optional) `export GITHUB_TOKEN=...` for higher API limits.

Deploy:

```bash
npm run deploy
```

This runs build + pushes `docs/.vitepress/dist` to `gh-pages` branch.

Build only:

```bash
npm run docs:build
```

Preview built site (after build):

```bash
npm run docs:preview
```

## Local Development

```bash
npm run docs:dev
```

Hot reload, auto-regenerates version file on start (not on every edit).

## Custom Domain

File `docs/public/CNAME` already contains:

```text
butler-sheet-icons.ptarmiganlabs.com
```

Ensure DNS: CNAME `butler-sheet-icons.ptarmiganlabs.com` → `ptarmiganlabs.github.io`. Then enable HTTPS in Pages settings when cert becomes available.

## Environment Variables

Optional: `GITHUB_TOKEN` / `GH_TOKEN` / `GITHUB_AUTH_TOKEN` used for authenticated GitHub API calls (avoids rate limiting). Not required in CI (Actions supplies token automatically).

## Troubleshooting (Quick)

| Issue                | Action                                                                             |
| -------------------- | ---------------------------------------------------------------------------------- |
| Version shows v0.0.0 | Token missing or API rate limited; set a token and rebuild                         |
| Build fails          | Run `npm ci && npm run docs:build` locally; check image paths under `docs/public/` |
| Pages not updating   | Check latest workflow run logs; verify Pages source = GitHub Actions               |
| 404 after deploy     | If first deploy, wait for Pages provisioning (usually < 2 min)                     |
| Wrong links/base     | If hosting under a path, adjust `base` in VitePress config                         |

## Minimal Maintenance Tasks

1. Keep devDependencies (vitepress, gh-pages) updated (Renovate handles this if enabled).
2. Verify version file still loads after upstream repo tag naming changes.
3. Review workflow permissions if tightening security (needs pages:write + id-token:write).
